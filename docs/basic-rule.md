# 基本規約

- 作業は必ずissueチケット単位で行ってください。  
  - 事前にissueを作成し、作業内容・目的・背景・完了条件を明記してください。
  - 修正が200行を超える場合は、タスク分割の必要性を責任者に相談し、適切にissueを分割してください。
  - issue番号や関連するPR番号は、コミットメッセージやPRの説明欄に必ず記載してください。
  - 作業内容に不明点や懸念点がある場合は、着手前に必ずチーム内で相談してください。

- コミットコメントには必ず以下のフォーマットを使用してください。
  - `{prefix}: {issue番号} {内容}`
    - 例：`feat: #123 ユーザー登録APIの追加`
  - プレフィックスは以下から選択してください。
    - `feat: `: 機能の追加
    - `fix: `: 不具合の修正
    - `refactor: `: リファクタリング
    - `style: `: 機能を変更しない、コードの見た目の修正（例: rubocop対応など）
    - `spec: `: テスト関連（テスト追加、変更、フィクスチャの修正など）
  - issue番号は必ず半角で記載し、`#`を付与してください。
  - 内容は簡潔かつ具体的に記載してください。
  - 複数のissueに関連する場合は、すべてのissue番号を記載してください（例：`fix: #12 #34 バリデーション修正`）。
- コミットは「一言で言い表せる大きさ」で区切って行ってください。  
  - 1コミットで複数の目的や大きな変更をまとめないようにしてください。
  - 例：バグ修正とリファクタリングを同時にコミットしない、1つの機能追加ごとにコミットする、など。
  - レビューや履歴の追跡が容易になるよう、変更内容を小さく明確に分割してください。
**⚠️ マイグレーションファイルの編集は禁止です。**

既存のマイグレーションファイルを修正したい場合は、**必ず新規のマイグレーションファイルを作成**してください。  
理由：マイグレーションの履歴整合性を保ち、チーム開発や本番運用時のトラブルを防ぐためです。

- 既存のマイグレーションファイル（`db/migrate/xxxx_xx_xx_xxxxxx_*.rb`）の直接編集は絶対に行わないでください。
- スキーマ変更や修正が必要な場合は、`rails generate migration` コマンド等で新しいマイグレーションを追加してください。
- 例外的な事情がある場合は、必ずリードエンジニアまたは責任者に事前相談してください。


## セキュリティ規約

- CORS（クロスオリジンリソースシェアリング）の設定は、最小権限の原則に従い、必要なオリジンのみを許可すること。ワイルドカード（`*`）の使用は原則禁止とする。
- APIや管理画面など、外部公開が不要なエンドポイントはCORSを無効化すること。
- 認証・認可が必要なリソースには、必ず適切な認証・認可処理を実装すること。
- セッションやトークンなどの機密情報は、セキュアな方法で生成・保存・送信すること。
- 不要なヘッダーや情報はレスポンスに含めないこと。
- 外部サービスとの連携時も、必要最小限の権限・スコープのみを付与すること。

## コーディング規約

- コーディングスタイルは原則として[RuboCop](https://github.com/rubocop/rubocop)の規約に従うこと。
- RuboCopによる自動修正が可能な警告は、必ず修正すること。
- RuboCopの設定ファイル（`.rubocop.yml`）に明示的な理由なく例外を追加しないこと。
- ファイルの末尾には必ず空行を入れること。
- 新たに実装するコードには必ずテストを作成すること。テストの無いコードのマージは認めません。
- ただし、既存のテストで十分に検証可能な場合（リグレッションテスト等）は、追加テストが無くても良いものとします。その場合は、既存テストでカバーされていることをプルリクエスト等で明記してください。
- 外部エンドポイントやURLなどのハードコードは禁止します。これらの設定値は必ず環境変数または定数クラス（例：`Settings`や`Config`など）にまとめて管理し、複数箇所で重複して設定されることがないようにしてください。
- クラス、メソッド、定数、スコープ、バリデーション、コールバックなど、あらゆるコード要素には必ずコメントを記述してください。  
  - コメントは日本語で簡潔かつ具体的に記載し、役割や注意点が明確になるようにします。
  - 例：  
    ```ruby
    # ユーザーのメールアドレスを一意に検証するバリデーション
    validates :email, uniqueness: true
    ```
  - コメントが不要と思われる場合も、なぜ不要なのかを明示的に記載してください（例：# RuboCopの自動生成コードのためコメント省略）。
- メソッドは常に単一責任の原則（Single Responsibility Principle）を守ること。
  - 1つのメソッドが複数の責務（処理や目的）を持たないように実装してください。
  - 複雑な処理や複数の役割を持つ場合は、適切にメソッドを分割し、それぞれの役割を明確にすること。
  - 例：
    ```ruby
    # ユーザー情報を更新する（バリデーションと保存を分離）
    def update_user_info(user, params)
      validate_user_params(params)
      user.update(params)
    end

    # パラメータのバリデーションを行う
    def validate_user_params(params)
      # バリデーション処理
    end
    ```
- コントローラはルーティングやリクエスト/レスポンス処理に専念し、ビジネスロジックは記述しないこと。
- モデルはデータの永続化やバリデーション、関連付けなどエンティティの管理に集中させること。
- ビジネスロジックや複雑な処理は必ず`app/service`配下にサービスクラスとして実装し、コントローラやモデルから呼び出す設計とすること。
  - サービスクラスには役割や利用方法を明記したコメントを記載すること。
  - 例：
    ```ruby
    # ユーザーのポイント加算処理を行うサービス
    class UserPointService
      def add_points(user, points)
        # ポイント加算処理
      end
    end
    ```

- マイグレーションを修正した場合、既存データとの整合性に注意し、古いデータでテストが失敗しないか必ず確認してください。
- 特に `null` を許可しないカラムを追加する場合は、必ず `default` 値を設定し、既存レコードにも適切な値が入るようにしてください。
- マイグレーション後は、ローカルやCI環境で全テストを実行し、意図しないテスト失敗がないことを確認してください。



## テスト規約

### 単体テスト

- 単体テストは、データベース接続や外部API連携を行わないこと。  
  - もしDB接続やAPI連携が必要な場合は、テストハーネスやモック、スタブ等を用いて外部依存を排除したテストを作成すること。
  - どうしても外部接続が必要な場合は、単体テストではなく結合テストやシステムテストとして実装し、テスト種別を明確に区別してください。
  - テストハーネスやモックの実装方針は、プロジェクトのテストガイドラインに従うこと。
- 単体テストでは、各メソッドやクラスの責務ごとにテストケースを分離し、網羅的にテストを作成すること。
- テストコードにも十分なコメントを記載し、テストの意図や前提条件が明確になるようにしてください。


### 結合テスト

結合テストはGitHub ActionsとRSpecを用いて実施します。  
- 実際のリクエストをAPIやコントローラに送信し、レスポンス内容・HTTPステータス・DBの状態・副作用などを横断的に検証してください。
- FactoryBot等を活用し、必要なテストデータを事前に用意すること。
- 期待される振る舞いごとにテストケースを分離し、網羅的に記述してください。
- テストコードには十分なコメントを記載し、テストの目的や前提条件、検証内容が明確になるようにしてください。
- 外部サービスとの連携がある場合は、必要に応じてVCRやWebMock等でリクエストをモックし、安定したテストを実現してください。
- 結合テストの実行はCI（GitHub Actions）上で自動化し、常に最新の状態でテストが実施されるようにしてください。
- 結合テストは、仕様変更があった場合のみ内容を更新してください。
- テストが失敗した場合でも、仕様に基づかない修正（テストを通すためだけの修正）は絶対に行わないこと。
- テスト修正時は、必ず仕様変更内容を確認し、必要に応じて関係者と合意を取った上で対応してください。

### システムテスト

システムテストはGitHub ActionsとCapybaraを用いて実施します。  
- システムテストは各マイルストーンのタイミングで実行してください。
- 実際のブラウザ操作を自動化し、ユーザー視点での一連の操作や画面遷移、UI要素の表示・非表示、バリデーション、エラー表示などを総合的に検証します。
- 必要に応じてFactoryBot等でテストデータを準備し、テストの前提条件を明確にしてください。
- テストケースごとに十分なコメントを記載し、テストの目的やシナリオ、期待される結果を明示してください。
- 外部サービスとの連携がある場合は、WebMockやVCR等を活用し、安定したテスト実行を担保してください。
- システムテストの実行結果は必ず記録し、失敗時は原因を特定し、仕様や要件に基づいて修正を行ってください。
- システムテストの内容は、マイルストーンや仕様変更に応じて適宜見直し・更新してください。
